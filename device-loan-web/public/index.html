<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDLS - Device Loan System</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .device-card { transition: transform 0.2s; height: 100%; }
        .device-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .device-img { height: 200px; object-fit: cover; background-color: #e9ecef; }
        .status-badge { position: absolute; top: 10px; right: 10px; }
        .nav-tabs .nav-link.active { font-weight: bold; border-bottom: 3px solid #0d6efd; }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="fas fa-laptop-code me-2"></i>CDLS</a>
        <div class="d-flex align-items-center text-white" id="user-info-nav" style="display: none !important;">
            <div class="me-3 text-end">
                <div class="fw-bold" id="username-display">User</div>
                <small class="text-secondary badge bg-light text-dark" id="role-display">Role</small>
            </div>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
</nav>

<div class="container">

    <!-- Auth Section -->
    <div id="auth-section" class="row justify-content-center mt-5">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white text-center py-4">
                    <h4 class="mb-0">Welcome Back</h4>
                    <p class="text-muted small mb-0">Sign in to manage device loans</p>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" id="login-username" class="form-control" value="student1" placeholder="e.g. student1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select id="login-role" class="form-select">
                            <option value="student">Student</option>
                            <option value="staff">Staff</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="login()">
                        Sign In
                    </button>
                    <div class="mt-3 text-center">
                        <small class="text-muted">Demo: Use any username. Password is skipped.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-section" class="d-none">
        
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices-pane" type="button" role="tab">
                    <i class="fas fa-boxes me-2"></i>Available Devices
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reservations-tab" data-bs-toggle="tab" data-bs-target="#reservations-pane" type="button" role="tab">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span id="reservations-tab-label">My Bookings</span>
                </button>
            </li>
        </ul>

        <!-- Tabs Content -->
        <div class="tab-content" id="mainTabsContent">
            
            <!-- Devices Tab -->
            <div class="tab-pane fade show active" id="devices-pane" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-secondary">Inventory Catalog</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadDevices()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div id="device-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    <!-- Devices injected here -->
                    <div class="col text-center py-5"><div class="spinner-border text-primary"></div></div>
                </div>
            </div>

            <!-- Reservations Tab -->
            <div class="tab-pane fade" id="reservations-pane" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-secondary" id="reservations-title">Current Reservations</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="fetchReservations()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Device</th>
                                        <th>User</th>
                                        <th>Status</th>
                                        <th>Return Due</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reservation-list">
                                    <!-- Reservations injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Bootstrap Bundle JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let CONFIG = {};
    let TOKEN = null;
    let CURRENT_USER = null;

    // Robust fetch wrapper
    async function safeFetch(url, options = {}) {
        try {
            const res = await fetch(url, options);
            const text = await res.text();

            if (!res.ok) {
                // Try to parse JSON error from backend if possible
                let errorMessage = text || "(empty response)";
                try {
                    const errorJson = JSON.parse(text);
                    if (errorJson.error) errorMessage = errorJson.error;
                    else if (errorJson.message) errorMessage = errorJson.message;
                } catch (e) {
                    // ignore
                }
                throw new Error(`HTTP ${res.status}: ${errorMessage}`);
            }

            return text ? JSON.parse(text) : null;
        } catch (e) {
            console.error("Fetch failed:", e);
            throw e;
        }
    }

    async function init() {
        try {
            const res = await fetch('config.json');
            CONFIG = await res.json();
        } catch (e) {
            console.error("Failed to load config", e);
        }
    }

    async function login() {
        const username = document.getElementById('login-username').value;
        const role = document.getElementById('login-role').value;

        if (!username) return alert("Please enter a username");

        try {
            const data = await safeFetch(`${CONFIG.BOOKING_API}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, role })
            });
            
            if (data.token) {
                TOKEN = data.token;
                CURRENT_USER = { username, role };
                
                // UI Switch
                document.getElementById('auth-section').classList.add('d-none');
                document.getElementById('main-section').classList.remove('d-none');
                document.getElementById('user-info-nav').style.setProperty('display', 'flex', 'important');
                
                // Update User Info
                document.getElementById('username-display').textContent = username;
                document.getElementById('role-display').textContent = role.toUpperCase();
                
                // Update Tab Labels based on Role
                if (role === 'staff') {
                    document.getElementById('reservations-tab-label').textContent = 'All Reserved Devices';
                    document.getElementById('reservations-title').textContent = 'All Active Reservations (Staff View)';
                } else {
                    document.getElementById('reservations-tab-label').textContent = 'My Bookings';
                    document.getElementById('reservations-title').textContent = 'My Active Reservations';
                }

                loadDevices();
                fetchReservations();
            }
        } catch (e) {
            alert('Login failed: ' + e.message);
        }
    }

    function logout() {
        TOKEN = null;
        CURRENT_USER = null;
        document.getElementById('auth-section').classList.remove('d-none');
        document.getElementById('main-section').classList.add('d-none');
        document.getElementById('user-info-nav').style.setProperty('display', 'none', 'important');
        
        // Reset Inputs
        document.getElementById('login-username').value = 'student1';
        document.getElementById('login-role').value = 'student';
    }

    async function loadDevices() {
        try {
            const devices = await safeFetch(`${CONFIG.INVENTORY_API}/devices`);
            
            const container = document.getElementById('device-list');
            container.innerHTML = '';
            
            if (devices.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted">No devices found.</div>';
                return;
            }

            devices.forEach(d => {
                const isAvailable = d.available_quantity > 0;
                const imageSrc = d.image || 'https://via.placeholder.com/300x200?text=No+Image';
                
                const div = document.createElement('div');
                div.className = 'col';
                div.innerHTML = `
                    <div class="card device-card h-100 border-0 shadow-sm">
                        <div class="position-relative">
                            <img src="${imageSrc}" class="card-img-top device-img" alt="${d.model}">
                            <span class="badge ${isAvailable ? 'bg-success' : 'bg-danger'} status-badge">
                                ${d.available_quantity} / ${d.total_quantity} Available
                            </span>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="mb-2">
                                <span class="badge bg-light text-secondary border">${d.category}</span>
                                <span class="badge bg-light text-secondary border">${d.brand}</span>
                            </div>
                            <h5 class="card-title">${d.model}</h5>
                            <div class="mt-auto pt-3">
                                <button class="btn ${isAvailable ? 'btn-primary' : 'btn-secondary'} w-100" 
                                        onclick="reserve('${d.id}')" 
                                        ${!isAvailable ? 'disabled' : ''}>
                                    ${isAvailable ? '<i class="fas fa-plus-circle me-1"></i> Reserve (2 Days)' : 'Out of Stock'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        } catch (e) {
            console.error(e);
            document.getElementById('device-list').innerHTML = '<div class="alert alert-danger">Error loading devices</div>';
        }
    }

    async function reserve(deviceId) {
        if (!confirm('Confirm reservation for 2 days?')) return;

        try {
            const data = await safeFetch(`${CONFIG.BOOKING_API}/reservations`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${TOKEN}`
                },
                body: JSON.stringify({ deviceId, quantity: 1 })
            });

            // If we get here, it's a success
            // Show toast or alert
            alert('Success: ' + (data.info || 'Reserved'));
            loadDevices(); // Refresh inventory
            fetchReservations(); // Refresh list
            
            // Switch to reservations tab to show the new booking
            const triggerEl = document.querySelector('#reservations-tab');
            bootstrap.Tab.getInstance(triggerEl).show();

        } catch (e) {
            alert('Reservation failed: ' + e.message);
        }
    }

    async function fetchReservations() {
        try {
            const reservations = await safeFetch(`${CONFIG.BOOKING_API}/reservations`, {
                headers: { 'Authorization': `Bearer ${TOKEN}` }
            });

            const container = document.getElementById('reservation-list');
            container.innerHTML = '';

            if (reservations.length === 0) {
                container.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No active reservations found.</td></tr>';
                return;
            }

            reservations.forEach(r => {
                let statusBadge = '';
                switch(r.status) {
                    case 'reserved': statusBadge = '<span class="badge bg-warning text-dark">Reserved</span>'; break;
                    case 'collected': statusBadge = '<span class="badge bg-primary">Collected</span>'; break;
                    case 'returned': statusBadge = '<span class="badge bg-success">Returned</span>'; break;
                    default: statusBadge = `<span class="badge bg-secondary">${r.status}</span>`;
                }

                let actions = '';
                // Staff only actions
                if (CURRENT_USER.role === 'staff') {
                    if (r.status === 'reserved') {
                        actions += `<button class="btn btn-sm btn-outline-warning me-1" onclick="collect('${r.id}')" title="Mark Collected"><i class="fas fa-hand-holding"></i> Collect</button>`;
                    }
                    if (r.status === 'collected') {
                        actions += `<button class="btn btn-sm btn-outline-success" onclick="returnDevice('${r.id}')" title="Mark Returned"><i class="fas fa-check"></i> Return</button>`;
                    }
                } else {
                    actions = '<span class="text-muted small">No actions</span>';
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><code>${r.id.substring(r.id.length - 6)}</code></td>
                    <td class="fw-bold">${r.deviceName}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-placeholder bg-light rounded-circle text-center me-2" style="width:30px;height:30px;line-height:30px">
                                <i class="fas fa-user text-secondary"></i>
                            </div>
                            <div>
                                <div>${r.userId}</div>
                                <div class="small text-muted" style="font-size:0.75rem">${r.userRole}</div>
                            </div>
                        </div>
                    </td>
                    <td>${statusBadge}</td>
                    <td>${new Date(r.returnDate).toLocaleDateString()}</td>
                    <td class="text-end">${actions}</td>
                `;
                container.appendChild(tr);
            });
        } catch (e) {
            console.error(e);
            document.getElementById('reservation-list').innerHTML = '<tr><td colspan="6" class="text-danger text-center">Error loading reservations</td></tr>';
        }
    }

    async function collect(id) {
        if (!confirm('Mark device as COLLECTED?')) return;
        await performAction(`${CONFIG.BOOKING_API}/reservations/${id}/collect`);
    }

    async function returnDevice(id) {
        if (!confirm('Mark device as RETURNED?')) return;
        await performAction(`${CONFIG.BOOKING_API}/reservations/${id}/return`);
    }

    async function performAction(url) {
        try {
            const data = await safeFetch(url, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${TOKEN}` }
            });
            
            // alert(data.message);
            loadDevices();
            fetchReservations();
        } catch (e) {
            alert('Action failed: ' + e.message);
        }
    }

    init();
</script>

</body>
</html>
